name: 1CI/CD to Minikube on EC2

on: workflow_dispatch

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Kubernetes Environment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ vars.DOCKER_USERNAME }}" --password-stdin

      - name: Build and Push image
        run: |
          chmod 777 ./gradlew
          ./gradlew build
          cd banking
          
          IMAGE_NAME=${{ vars.DOCKER_USERNAME }}/banking:latest
          # Build and push using docker-compose
          docker compose -f docker-compose.yml build
          docker compose -f docker-compose.yml push


      - name: Deploy to Minikube on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ vars.EC2_HOST }}
          username: ${{ vars.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            set -euo pipefail

            if [ ! -d "$HOME/hungry_town" ]; then
              git clone https://github.com/RathiKrithika/hungry_town "$HOME/hungry_town"
            fi
            cd "$HOME/hungry_town/banking/k8s"
            git pull origin main

            # Ensure Minikube is running
            if ! minikube status >/dev/null 2>&1; then
              minikube start --driver=docker
            fi

            # Docker registry secret
            kubectl delete secret docker-secret --ignore-not-found

            kubectl create secret docker-registry docker-secret \
              --docker-username=${{ vars.DOCKER_USERNAME }} \
              --docker-password=${{ secrets.DOCKER_PASSWORD }} \
              --docker-email=${{ vars.DOCKER_EMAIL }}

            # Deploy Kubernetes manifests
            kubectl apply -f deployment.yml
            kubectl apply -f service.yml
            kubectl rollout status deployment/banking --timeout=120s
